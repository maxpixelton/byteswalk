# Docker 镜像

- Docker 镜像

- Union File System（联合文件系统）技术

- Docker 镜像分层

- Docker 镜像分层原理


## Docker 镜像

**镜像是一种轻量级、可执行的独立软件包，用来打包软件环境和基于运行环境开发的软件，它包含运行某个软件所需要的所有内容，包括代码、运行时的库、环境变量和配置文件。**

**镜像是一个只读模板**，带有创建 Docker 容器的说明。通常，一个镜像基于另一个镜像，并带有一些额外的定制。例如：可以构建一个基于 ubuntu 镜像的镜像，安装 Apache web 服务器和自己的应用程序，以及运行应用程序所需的配置细节，最终服务运行或项目运行都是在容器中的。

我们可以从开源镜像仓库拉取镜像，在拉取镜像的时候，会发现 Docker 给出的回显中，镜像似乎是分很多层的。

```shell
[root@node1 ~]# docker pull quay.io/coreos/flannel:v0.14.0
v0.14.0: Pulling from coreos/flannel
801bfaa63ef2: Pull complete 
e4264a7179f6: Pull complete 
bc75ea45ad2e: Pull complete 
78648579d12a: Pull complete 
3393447261e4: Pull complete 
071b96dd834b: Pull complete 
4de2f0468a91: Pull complete 
Digest: sha256:4a330b2f2e74046e493b2edc30d61fdebbdddaaedcb32d62736f25be8d3c64d5
Status: Downloaded newer image for quay.io/coreos/flannel:v0.14.0
```

这是一个非常有意思的现象，因为它引出了容器领域极其重要的技术：**Union File System（联合文件系统）技术**。正是该技术的利用，容器技术才会大行其道。

## Union File System（联合文件系统）技术

**联合文件系统（Union File System）是一种将多个文件系统挂载到通一目录下的技术，使得这些文件系统中的内容可以像一个文件系统一样被访问。** 

在联合文件技术中，多个不同的文件系统以层次结构的形式被组织在一起，从而使得用户可以通过单一的挂载点来访问多个不同的文件系统。

联合文件系统的实现使用了一些特殊的技术

- **链接（Link）**。联合文件系统使用 **链接技术** 将多个不同的文件系统的内容组合在一起，从而实现了文件系统的叠加。在联合文件系统中，每个文件系统都有一个挂载点，通过在这个挂载点叠加其它的文件系统，就可以将它们的内容融合在一起。

- **重定向（Redirect）**。该技术用来实现对文件和目录的访问，使得用户可以在联合文件系统中访问多个不同文件系统的内容，同时还能够自由地添加、删除或更改这些文件系统中的文件和目录。

联合文件系统的优点包括：

1. **将多个不同的文件系统整合在一起**，从而方便用户管理和访问这些文件系统中的内容。

2. **在不同文件系统之间共享文件和目录**。

3. 根据需要动态地添加、删除和更改文件系统，从而提高系统的灵活性。

联合文件系统的缺点也很明显，包括：

1. 导致性能下降，出现一些安全问题。

2. 需要特殊的文件系统支持等问题。

3. ...

联合文件系统可以将只读和读写文件系统合并在一起，具有 **Copy-on-Write** 功能，允许只读文件系统的修改可以保存到可写文件系统当中。


!!! note

    假设有两个文件系统：A 和 B。

    其中，A 包括文件 `/A/foo` 和目录 `/A/bar`，B 包含文件 `/B/bar` 和目录 `/B/foo`。

    使用联合文件系统可以将这两个文件系统合并成一个单独的文件系统 C，操作如下：

    1. 创建一个目录 `/C`，作为联合文件系统的挂载点。

    2. 将文件系统 A 挂载到 `/C` 上，使得文件 `/A/foo` 和目录 `/A/bar` 可以在 `/C` 目录下访问。

    3. 将文件系统 B 挂载到 `/C` 上，因为 `/C` 目录以及被 A 挂载，因此 B 将被挂载到 `/C` 目录下的一个新的子目录，比如 `/C/B`。

    4. 现在，/C 目录下的内容将包括 A 和 B 两个文件系统的内容。因此，用户可以通过 `/C/foo` 访问文件 `/A/foo`，通过 `/C/bar` 访问目录 `/A/bar`，通过 `/C/B/bar` 访问文件 `/B/bar`，通过 `/C/B/foo` 访问目录 `/B/foo`。

## 回说 Docker 镜像分层

### 基础概念

联合文件系统是 Docker 镜像的基础。

**镜像可以通过分层来进行继承，基于基础镜像，可以制作各种具体的应用镜像。**

Docker 镜像是由多个分层（layers）组成的，每个分层都包含了文件系统的一部分。这种分层设计使得 Docker 镜像非常轻量级，因为多个镜像可以共享相同的分层。**当一个新的镜像被创建时，Docker 只需要为新镜像添加一些额外的分层，而不是重新创建整个文件系统。**

每个 Docker 镜像都由一个或多个分层组成，这些分层从 **基础镜像** 开始，一步步地添加文件系统的修改。每个分层都有一个唯一的 ID，并且可以在其他镜像中被共享。**当我们启动一个容器时，Docker 会将这个容器的文件系统组合成一个只读的联合文件系统，其中包含了容器所使用的所有分层。** 这种方式可以让容器在启动时非常快速地创建。

联合文件系统一次同时加载多个文件系统，但从外面看起来，只能看到一个文件系统，联合加载会把各层文件系统叠加起来，这样最终的文件系统会包含所有底层的文件和目录。

### 基础镜像

在 Docker 中，基础镜像是构建其它镜像的起点。**基础镜像是一个包含操作系统和一些最基本软件包的最小镜像，它提供了一个最小的运行环境，使得应用程序可以在 Docker 容器中运行。**

基础镜像可以由用户自己创建，也可以从 Docker Hub 或其他 Docker 镜像仓库中获取。例如：**一个常见的基础镜像是 ubuntu，它提供了一个基于 Ubuntu 操作系统的最小环境。在此基础镜像上，我们可以构建自己的应用程序或服务的镜像，添加所需的软件包和配置文件。**





### 内核空间和用户空间的文件系统

## Docker 镜像分层原理

### 基本原理

### 什么要镜像分层

### 容器 Copy-on-Write(COW) 特性

### 可写的容器层

### 小示例